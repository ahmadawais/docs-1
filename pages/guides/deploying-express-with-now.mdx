import Guide from '~/components/layout/guide'
import { InlineCode } from '~/components/text/code'
import Caption from '~/components/text/caption'
import { GenericLink } from '~/components/text/link'
import Card from '~/components/card'

export const meta = {
  title: 'Deploying Express.js with Now',
  description:
    'Learn how to best deploy an Express app in a Serverless environment.',
  published: '2019-05-24T20:03:07.360Z',
  authors: ['paulogdm'],
  url: '/guides/deploying-express-with-now',
  editUrl: 'pages/guides/deploying-express-with-now.mdx',
  lastEdited: '2019-05-24T20:03:07.360Z'
}

[Express.js](https://expressjs.com) is a [very popular](https://stackoverflow.com/questions/tagged/express) Node.js framework that serves as a base for applications everywhere. Commonly used for monolithic and server-oriented environments, with [Now](https://now.sh) you will be able to deploy a Serverless with a few lines of configuration.

In this guide, we will walk you through the steps necessary to deploy an optimized [Express.js](https://expressjs.com/) app to Now, basic concepts of the platform and also a simple but effective way to make your app faster.

## Step 1: Builders

Let's start with a typical [Express.js]() app:

```js
var app = require('express')()
var { getPets, postPets } = require('pets.js')
var { postOwner, deleteOwner } = require('owner.js')

app.get('/', (req, res) => { res.send('hello world') })
app.get('/pet/:id', getPets)
app.post('/pet', postPets)
app.post('/owner', postOwner)
app.delete('/owner', deleteOwner)
app.listen(3000)
```
<Caption>
  Example of{' '}
  <GenericLink href="https://expressjs.com/">
    Express.js
  </GenericLink>{' '}app with three routes.
</Caption>

Every dynamic deployment in Now requires a builder.
We can imagine a builder as being a little helper that will make our code smaller and also produce a set of results.
In fact, it is a little adapter that will wrap our application in a way that it can easily interface with specific Lambda formats and other requirements of the environment.

For this guide, we will use two of the official builders, `@now/node` and `@now/node-server`. The first is the recommended one since the overhead of listening to a server in a lambda environment can be noticeable and affect performance.

Using our first block of code as an example, the following configuration would be needed:

```json
{
  "version": 2,
  "builds": [{"src": "myapp.js", "use": "@now/node-server"}],
  "routes": [{"src": "/(.*)", "dest": "/myapp.js"}]
}
```
<Caption>
  Using{' '}
  <GenericLink href="/docs/v2/deployments/official-builders/node-js-server-now-node-server">
    <InlineCode>@now/node-server</InlineCode>{' '}builder
  </GenericLink>.
</Caption>

However, with a little adaptation, we can use `@now/node` to fully enjoy the power of a Serverless environment.
If we insert the line `module.exports = app` and also listen to a port conditionally, for example:

```js
var app = require('express')()
var { getPets, postPets } = require('pets.js')
var { postOwner, deleteOwner } = require('owner.js')

app.get('/', (req, res) => { res.send('hello world') })
app.get('/pet/:id', getPets)
app.post('/pet', postPets)
app.post('/owner', postOwner)
app.delete('/owner', deleteOwner)

if (!process.env.NOW_REGION) app.listen(3000) // if code is not in a NOW Region

module.exports = app
```
<Caption>
  Example of{' '}
  <GenericLink href="https://expressjs.com/">
    Express.js
  </GenericLink>{' '} adapted for <InlineCode>@now/node</InlineCode>.
</Caption>

We will allow our app to use `@now/node`:

```json
{
  "version": 2,
  "builds": [{"src": "myapp.js", "use": "@now/node"}],
  "routes": [{"src": "/(.*)", "dest": "/myapp.js"}]
}
```
<Caption>
  A{' '}
  <GenericLink href="/docs/v2/deployments/configuration">
    <InlineCode>now.json</InlineCode> configuration file
  </GenericLink>{' '}
  showing the usage of{' '}
  <GenericLink href="/docs/v2/deployments/official-builders/node-js-now-node">
    <InlineCode>@now/node</InlineCode>{' '}builder
  </GenericLink>.
</Caption>

That is possible because `@now/node` [requires a function handler](https://zeit.co/docs/v2/deployments/official-builders/node-js-now-node/#when-to-use-it) in the format `module.exports = (req, res) => {...}` and when creating a new Express instance, that is exactly what it is internally.

## Step 2: Routing

It is very common to write a series of functions with callbacks to handle a set of entry points. From our last code block, let's cut it out a little bit so we can focus on the concepts of routing:

```js
var app = require('express')()
var { getPets, postPets } = require('pets.js')

app.get('/', (req, res) => { res.send('hello world') })
app.get('/pet/:id', getPets)
app.post('/pet', postPets)

module.exports = app
```
<Caption>
  Example of{' '}
  <GenericLink href="https://expressjs.com/">
    Express.js
  </GenericLink>{' '}app with three routes.
</Caption>

When using Now, the platform will handle the routing of the app like how files are arranged in the filesystem. Any attempt to fetch `/pet/1` will result in a 404 because `/pet/1` doesn't exist. So we need the following configuration:

```json
{
  "version": 2,
  "builds": [{"src": "myapp.js", "use": "@now/node"}],
  "routes": [
    {"src": "/", "dest": "/myapp.js"},
    {"src": "/pet", "dest": "/myapp.js"},
    {"src": "/pet/[^/]+", "dest": "/myapp.js"}
  ]
}
```
<Caption>
  A{' '}
  <GenericLink href="/docs/v2/deployments/routes/">
    <InlineCode>"routes"</InlineCode> configuration
  </GenericLink>{' '}
  that redirects requests to a lambda if they match one of those three sources.
</Caption>

It is possible to enumerate those routes as they are in `myapp.js`. 
The only thing we need to be careful is both the order of routes and the PCRE regex.
To make sure everything will work when deployed to `now`, [`now dev`](https://zeit.co/blog/now-dev) is the recommended tool to test our deployments effortless.

Since listing all routes in the `now.json` can be a time consuming task, we can take advantage of the PCRE regex in [`"src"`](https://zeit.co/docs/v2/deployments/routes/#src) and make it just one line:

```json
{
  "version": 2,
  "builds": [{"src": "myapp.js", "use": "@now/node"}],
  "routes": [{"src": "/.*", "dest": "/myapp.js"}]
}
```
<Caption>
  A{' '}
  <GenericLink href="/docs/v2/deployments/routes/">
    <InlineCode>"routes"</InlineCode> configuration
  </GenericLink>{' '}
  that redirects every request to a single lambda.
</Caption>

To see the full specification for `"routes"` on our [documentation](/docs/v2/deployments/routes/). In the example above we are describing a "catch-all" route that will redirect all traffic to the lambda `myapp.js`.

## Step 3: Improving Performance

The first two steps of this guide was an introduction on how you could deploy your code as-is in a Serverless platform.
However, depending on the size of your app, it is a good idea to break it down as much as possible.
A dicussion about the impact of the size of your application in it's response time can be viewed in a [blog post](https://zeit.co/blog/customizable-lambda-sizes#code-size-and-its-impact-on-performance).

Let's say, for the sake of this guide, that we have the following block of code:

```js
var app = require('express')()
var { getPets, postPets } = require('pets.js')
var { postOwner, deleteOwner } = require('owner.js')

app.get('/', (req, res) => { res.send('hello world') })
app.get('/pet/:id', getPets)
app.post('/pet', postPets)
app.post('/owner', postOwner)
app.delete('/owner', deleteOwner)

module.exports = app
```
<Caption>
  Example of{' '}
  <GenericLink href="https://expressjs.com/">
    Express.js
  </GenericLink>{' '}app with five routes.
</Caption>

If we want to add more routes, that means a bigger Lambda and a hit on performance.
At this point, we can question if Express is a good framework for such environment, and the answer is yes if you are willing to make a few adaptations.
In contrast, you will enjoy the best performance possible that [Now.sh](http://now.sh) can provide.
We can break the code block above in such a way that it can generate five independent lambdas.
As an example, we will extract the routes related to `pets.js`:

```js
var app = require('express')()
var { postOwner, deleteOwner } = require('owner.js')

app.get('/', (req, res) => { res.send('hello world') })
app.post('/owner', postOwner)
app.delete('/owner', deleteOwner)

module.exports = app
```
<Caption>
  Example of{' '}
  <GenericLink href="https://expressjs.com/">
    Express.js
  </GenericLink>{' '}app with three routes.
</Caption>

```js
var app = require('express')()
var { getPets, postPets } = require('pets.js')

app.get('/pet/:id', getPets)
app.post('/pet', postPets)

module.exports = app
```
<Caption>
  Newly created{' '}
  <InlineCode>pets.js</InlineCode>
  {' '} file.
</Caption>

`now.json`

```json
{
  "version": 2,
  "builds": [
    {"src": "myapp.js", "use": "@now/node"},
    {"src": "pet.js", "use": "@now/node"}
  ],
  "routes": [
    {"src": "/pet(.*)", "dest": "/pet.js"},
    {"src": "/(.*)", "dest": "/myapp.js"}
  ]
}
```
<Caption>
  New{' '}
  <InlineCode>now.json</InlineCode>
  {' '} generating two lambdas.
</Caption>

The same process can be applied to the routes of `owner`, if there is a need to further optimize this app.

## Step 4: Static Files

It is common to use Express as the server that handles all the static assets of an application. However, we can avoid that and take advantage of `"routes"`, like this:

```json
"builds": [
  {"src": "myapp.js", "use": "@now/node"},
  {"src": "public/**", "use": "@now/static"}
]
"routes": [
    {"src": "/(css|js|images)/(.*)", "dest": "/public/$1/$2"},
    {"src": "/(.*)", "dest": "/myapp.js"}
  ]
}
```
<Caption>
  A{' '}
  <GenericLink href="/docs/v2/deployments/configuration">
    <InlineCode>now.json</InlineCode> configuration file
  </GenericLink>{' '}
  showing the usage of{' '}
  <GenericLink href="/docs/v2/deployments/official-builders/static-now-static">
    <InlineCode>@now/static</InlineCode>{' '}builder
  </GenericLink>.
</Caption>

When using the [routing configuration](/docs/v2/deployments/routes) to serve those assets, we are avoiding a lambda invocation saving resources and costs. 
Of course the method above only works for files that are fully static, and not for templates or dynamic content.

## Resources

For more information on working with Express.js, please refer to [their documentation](https://expressjs.com/en/api.html).

To configure [Now](/docs/v2/getting-started/introduction-to-now) further, please see these additional topics and guides:

<Card title="Deploying Basics" href="/docs/v2/deployments/basics">
  Deploy any of your applications with ZEIT Now.
</Card>

<Card
  title="Routes"
  href="zeit.co/docs/v2/deployments/routes/"
>
  Learn more about the `"routes"` configuration.
</Card>

<Card title="Lambda Lifecycle and Scalability" href="/docs/v2/deployments/concepts/lambdas/#lifecycle-and-scalability">
 Understand how the execution model of lambdas work.
</Card>

<Card title="More Guides" href="/guides">
  See more guides that help you move forward with your projects and deployments.
</Card>

export default ({ children }) => <Guide meta={meta}>{children}</Guide>
